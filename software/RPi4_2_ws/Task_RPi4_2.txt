# Section 0: System Architecture & Master Context (STRICT)

**Project:** ALTAIR Hexacopter Control System
**Type:** Voliro-type (Fully Actuated 12-DOF)
**Goal:** Develop a distributed control system for the ALTAIR drone.

## 0.1 Directory Structure (Root: `~/altair_project/`)
All code must assume this relative path structure.
* `software/`
    * `common/` (Shared resources)
        * `altair_description/` (URDF package with meshes)
    * `pico_firmware/` (Node A)
    * `RPi4_1_ws/` (Node B workspace)
    * `RPi4_2_ws/` (**Target for this task**)
        * `src/`
    * `gcs_tools_ws/` (PC workspace)

## 0.2 Node Roles & Hardware
* **Node A: RPi Pico (IO Hub)**
    * **Role:** Real-time IO.
* **Node B: RPi 4 #1 (Bridge)**
    * **Role:** Sensor Fusion, Mux.
    * **IP:** 192.168.10.1
* **Node C: RPi 4 #2 (Controller)** [Target]
    * **Role:** High-level Control (NMPC / PID).
    * **HW:** RPi 4 (Ubuntu 22.04).
    * **IP:** 192.168.10.2
* **Node GCS: PC**
    * **Role:** Human Interface.

## 0.3 ROS 2 Interface Specifications & QoS
**QoS Policy:** "SensorData" = Best Effort, Volatile.

| Topic Name | From | To | Type | Size | QoS | Notes |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| `/control/actuator_commands` | Node C | Node B | `Float32MultiArray` | 12 | SensorData | Output |
| `/odometry/filtered` | Node B | Node C | `nav_msgs/Odometry` | - | SensorData | Input |
| `/cmd_vel` | GCS | Node C | `geometry_msgs/Twist` | - | Reliable | Target |

---

# Section 1: Task Description (Node C)

**Objective:** Generate the **ROS 2 C++ Packages** for **Node C** inside `software/RPi4_2_ws/src/`.

**Specific Requirements:**

1.  **URDF Integration (Crucial):**
    * The code must assume `altair_description` exists in `software/common/`.
    * **Action:** On startup, parse `urdf/altair.urdf` to retrieve physical parameters:
        * Total Mass & Inertia Matrix.
        * Rotor relative positions & orientations (Transforms).
    * **Constraint:** Do NOT hardcode arm lengths or angles. Read them from the robot model.

2.  **Package: `altair_controller`**
    * Implement two selectable modes (Strategy pattern or separate nodes):
    * **Mode A: PID Mixer**
        * Standard cascaded PID for position/attitude.
        * **Allocation Matrix:** Compute the 12x6 pseudo-inverse matrix dynamically based on the URDF geometry.
    * **Mode B: NMPC (Nonlinear Model Predictive Control)**
        * Use Acados or CasADi.
        * Implement Hierarchical Control:
            * Thread 1 (20Hz): MPC Optimization (Horizon prediction).
            * Thread 2 (250Hz): Fast feedback linearization / Torque control.

3.  **Watchdog & Logic:**
    * Subscribe to `/cmd_vel`. If target command is lost for >1.0s, automatically switch `x_ref` to "Hover" or "Land".
    * Publish `/control/actuator_commands` using **SensorData QoS** (Best Effort).

4.  **Setup:**
    * Launch file `controller.launch.py` that loads the URDF to `robot_state_publisher` and starts the controller.
    * Script to optimize OS (CPU isolation) for the solver.